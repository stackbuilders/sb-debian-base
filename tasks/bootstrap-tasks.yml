---
- name: Make sure that the authorized_keys are present for the admin user
  authorized_key:
    user: "{{ admin_user }}"
    key: "{{ item }}"
  with_file:
    - keys/administrators

- name: Disallow SSH password authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present

- name: Disallow root SSH access
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart sshd
  when: ansible_distribution == "Debian"

- name: Disallow root SSH access for Ubuntu versions 14.04 and later
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart ssh
  when: ansible_distribution_release == "{{ item }}"
  with_items:
    - precise
    - trusty

- name: Set hostname to host-specific variable
  hostname: name={{ hostname }}
  when: hostname is defined
  tags:
    - set-hostname

- name: Set time zone
  command: timedatectl set-timezone {{ ntp_timezone }}

- name: Enable NTP
  command: timedatectl set-ntp true

- name: Update package cache and upgrade packages
  apt: upgrade=dist update_cache=yes

- name: Install extra packages
  apt: name={{ item }} state=latest
  with_items:
    - atsar
    - atop
    - curl
    - emacs24-nox
    - git
    - htop
    - libgmp-dev
    - tmux
    - tree
    - ufw
    - vim

- name: Debian version 8.5 introduced a bug, this is a workaround
  lineinfile:
    dest=/etc/default/ufw regexp=^IPV6=yes line=IPV6=no
  when: ansible_distribution == "Debian"

- name: Enable UFW
  ufw: state=enabled policy=deny

- name: Open general ports
  ufw: rule=allow port={{ item }}  proto=tcp
  with_items:
    - "{{ ports | default([22]) }}"

- name: Open ports by IP
  ufw: rule=allow port={{ item.value.port }}  proto=tcp src={{ item.value.ip }}
  with_dict: "{{ port_ips | default({}) }}"

- include: deploy-username-tasks.yml
  when: deploy_username is defined
