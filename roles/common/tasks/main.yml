---
- name: Add administrator user
  user: name=administrator comment="Privileged administrator user" uid=1001 group=sudo shell=/bin/bash
  remote_user: root
  tags:
    - prebootstrap

- name: Update packges
  apt: update_cache=yes
  tags:
    - prebootstrap

- name: Install sudo package
  apt: name={{ item }} state=present
  remote_user: root
  with_items:
    - sudo
  tags:
    - prebootstrap

- name: Sudo without password
  lineinfile: "dest=/etc/sudoers state=present regexp='^%sudo' line='%sudo ALL=(ALL) NOPASSWD: ALL'"
  remote_user: root
  tags:
    - prebootstrap

- name: Set up authorized_keys for the administrator user
  authorized_key: user=administrator
                  key="{{ item }}"
  with_file:
    - keys/administrator
  tags:
    - prebootstrap

- name: Disallow SSH password authentication
  remote_user: administrator
  become: yes
  become_method: sudo
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present
  tags:
    - bootstrap

- name: Disallow root SSH access
  remote_user: administrator
  become: yes
  become_method: sudo
  lineinfile:
   dest=/etc/ssh/sshd_config
   regexp="^PermitRootLogin"
   line="PermitRootLogin no"
   state=present
  notify:
    - restart sshd
  tags:
    - bootstrap

- name: Enable default repos
  apt_repository: repo='deb http://ftp.debian.org/debian/ jessie main' state=present
  remote_user: administrator
  become: yes
  become_method: sudo
  tags:
    - bootstrap

- name: Dist upgrade packges
  remote_user: administrator
  become: yes
  become_method: sudo
  apt: upgrade=dist
  tags:
    - bootstrap

- name: Install packges
  remote_user: administrator
  become: yes
  become_method: sudo
  apt: name={{ item }} state=present
  with_items:
    - vim
    - tmux
    - htop
    - atop
    - ufw
    - emacs24-nox
    - atsar
  tags:
    - bootstrap

- name: Create stackbuilders group
  remote_user: administrator
  become: yes
  become_method: sudo
  group: name=stackbuilders state=present
  tags:
    - bootstrap

- name: Add stackbuilders user
  remote_user: administrator
  become: yes
  become_method: sudo
  user: name=stackbuilders comment="Unprivileged Stack Builders User" groups=stackbuilders,sudo shell=/bin/bash
  tags:
    - bootstrap

- name: Configure UFW
  remote_user: administrator
  become: yes
  become_method: sudo
  ufw: state=enabled policy=disable
  ufw: logging=on
  ufw: rule=allow name=OpenSSH
  tags:
    - bootstrap

- name: Generate ufw rules
  template: src={{ item }}.j2
            dest=/lib/ufw/{{ item }}
            owner=root
            group=root
            mode=640
  with_items:
    - ufw_rules
  notify: Restart ufw
  tags:
    - ufw-rules

- name: Add FPCO Deb Key
  remote_user: administrator
  become: yes
  become_method: sudo
  apt_key: url=https://s3.amazonaws.com/download.fpcomplete.com/debian/fpco.key state=present
  tags:
    - haskell-stack

- name: Add FPCO Deb repository
  apt_repository: repo='deb http://download.fpcomplete.com/debian/jessie stable main' state=present
  remote_user: administrator
  become: yes
  become_method: sudo
  tags:
    - haskell-stack

- name: Update packges
  remote_user: administrator
  become: yes
  become_method: sudo
  apt: update_cache=yes
  tags:
    - haskell-stack

- name: Install Stack packges
  remote_user: administrator
  become: yes
  become_method: sudo
  apt: name=stack state=present
  tags:
    - haskell-stack
